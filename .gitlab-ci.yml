include:
  - local: 'terraform-runner/.gitlab-ci.yml'

before_script:
  - echo "$SERVICE_ACCOUNT_JSON" | base64 -d > service-account.json
  - gcloud auth activate-service-account "$SERVICE_ACCOUNT_NAME" --key-file=service-account.json
  - gcloud auth print-access-token | crane auth login -u oauth2accesstoken --password-stdin gcr.io 
  - rm -r $CI_PROJECT_DIR/service-account.json

stages:
  - build
  - test
  - deploy

build-job:
  stage: build
  image: gcr.io/devops-workshop-2023/terraform-runner:1.0.1
  only:
    - develop
  script:
    - cd terraform-runner
    - IMAGE_TAG="$(cat version.txt)"
    - crane manifest exists gcr.io/devops-workshops-2023/${CI_COMMIT_SHA}:${image_tag}
    - gcloud builds submit --project=$GCLOUD_PROJECT_ID --tag gcr.io/devops-workshops-2023/terraform-runner:${CI_COMMIT_SHA}
    - gcloud containers images add-tag gcr.io/devops-workshops-2023/terraform-runner:${CI_COMMIT_SHA} gcr.io/devops-workshops-2023/terraform-runner:${image_tag}

